name: ğŸš€ Deploy to GCP Ubuntu Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ æ£€æŸ¥å½“å‰ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ å°†é¡¹ç›®ä¸Šä¼ åˆ°ä½ çš„äº‘æœåŠ¡å™¨
      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: ".,!.git,!.github,!__pycache__,!*.pyc,!.pytest_cache,!.venv"
          target: "/opt/ci-cd-flask-demo"
          strip_components: 0

      # 3ï¸âƒ£ å¤‡ä»½å½“å‰è¿è¡Œçš„å®¹å™¨
      - name: Backup current container
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            if docker ps -a | grep -q ci-cd-demo; then
              echo "ğŸ“¦ Backing up current container..."
              docker tag ci-cd-demo:latest ci-cd-demo:backup || true
            fi

      # 4ï¸âƒ£ æ„å»ºæ–°çš„ Docker é•œåƒ
      - name: Build Docker image
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /opt/ci-cd-flask-demo
            echo "ğŸ›  Building Docker image..."
            docker build -t ci-cd-demo:latest . || exit 1
            echo "âœ… Image built successfully"

      # 5ï¸âƒ£ é›¶åœæœºéƒ¨ç½² - å¯åŠ¨æ–°å®¹å™¨
      - name: Deploy new container
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /opt/ci-cd-flask-demo

            # å¯åŠ¨æ–°å®¹å™¨åœ¨ä¸åŒç«¯å£
            echo "ğŸš€ Starting new container on port 8001..."
            docker run -d --name ci-cd-demo-new -p 8001:8000 ci-cd-demo:latest

            # ç­‰å¾…æ–°å®¹å™¨å¯åŠ¨
            echo "â³ Waiting for container to be ready..."
            sleep 5

            # å¥åº·æ£€æŸ¥
            echo "ğŸ¥ Health check..."
            for i in {1..10}; do
              if curl -f http://localhost:8001/health > /dev/null 2>&1; then
                echo "âœ… Health check passed!"

                # åœæ­¢æ—§å®¹å™¨
                echo "ğŸ”„ Switching traffic..."
                docker stop ci-cd-demo || true
                docker rm ci-cd-demo || true

                # é‡å‘½åæ–°å®¹å™¨å¹¶åˆ‡æ¢ç«¯å£
                docker stop ci-cd-demo-new
                docker rm ci-cd-demo-new
                docker run -d --name ci-cd-demo -p 8000:8000 ci-cd-demo:latest

                # æ¸…ç†å¤‡ä»½
                docker rmi ci-cd-demo:backup || true

                echo "âœ… Deployment complete!"
                exit 0
              fi
              echo "â³ Retry $i/10..."
              sleep 3
            done

            # å¥åº·æ£€æŸ¥å¤±è´¥ - å›æ»š
            echo "âŒ Health check failed! Rolling back..."
            docker stop ci-cd-demo-new || true
            docker rm ci-cd-demo-new || true

            if docker images | grep -q ci-cd-demo:backup; then
              docker tag ci-cd-demo:backup ci-cd-demo:latest
              docker restart ci-cd-demo || docker run -d --name ci-cd-demo -p 8000:8000 ci-cd-demo:latest
              echo "ğŸ”™ Rolled back to previous version"
            fi

            exit 1

      # 6ï¸âƒ£ éªŒè¯éƒ¨ç½²
      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "ğŸ” Verifying deployment..."
            if docker ps | grep -q ci-cd-demo; then
              echo "âœ… Container is running"
              docker ps | grep ci-cd-demo

              # æœ€ç»ˆå¥åº·æ£€æŸ¥
              if curl -f http://localhost:8000/health > /dev/null 2>&1; then
                echo "âœ… Service is healthy and responding"
                exit 0
              else
                echo "âš ï¸  Container running but health check failed"
                exit 1
              fi
            else
              echo "âŒ Container is not running"
              exit 1
            fi

      # 7ï¸âƒ£ æ¸…ç†æ—§é•œåƒ
      - name: Cleanup old images
        if: success()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "ğŸ§¹ Cleaning up old Docker images..."
            docker image prune -f
            echo "âœ… Cleanup complete"