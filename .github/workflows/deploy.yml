name: ğŸš€ Deploy to GCP Ubuntu Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ æ£€æŸ¥å½“å‰ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ è®¾ç½® Python ç¯å¢ƒ
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      # 3ï¸âƒ£ å®‰è£…åç«¯ä¾èµ–å¹¶è¿è¡Œæµ‹è¯•
      - name: Install backend dependencies and run tests
        run: |
          pip install -r requirements.txt
          pytest backend/tests --maxfail=1 --disable-warnings -q

      # 4ï¸âƒ£ è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # 5ï¸âƒ£ å‰ç«¯ç±»å‹æ£€æŸ¥
      - name: Lint / type-check frontend
        run: |
          cd frontend
          echo "ğŸ” Running svelte-check..."
          npm ci
          npm run check

      # 6ï¸âƒ£ æ„å»ºå‰ç«¯
      - name: Build frontend
        run: |
          cd frontend
          echo "ğŸ—ï¸ Building frontend..."
          npm run build
          echo "âœ… Frontend build complete!"
          ls -la dist/

      # 7ï¸âƒ£ å°†é¡¹ç›®ä¸Šä¼ åˆ°ä½ çš„äº‘æœåŠ¡å™¨
      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: ".,!.git,!.github,!__pycache__,!*.pyc,!.pytest_cache,!.venv,!src,!.trash,!frontend/node_modules,!.env,!.env.*,!.envrc"
          target: "/opt/ci-cd-flask-demo"
          strip_components: 0
          overwrite: true

      # 8ï¸âƒ£ åœæ­¢å½“å‰è¿è¡Œçš„æœåŠ¡å¹¶é‡Šæ”¾ç«¯å£
      - name: Stop current services and free ports
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /opt/ci-cd-flask-demo

            # åœæ­¢ docker-compose æœåŠ¡å¹¶æ¸…ç†å­¤ç«‹å®¹å™¨
            if [ -f docker-compose.yml ]; then
              echo "ğŸ›‘ Stopping docker-compose services..."
              docker compose down --remove-orphans || true
            fi

            # åœæ­¢æ‰€æœ‰ç›¸å…³çš„å®¹å™¨
            echo "ğŸ›‘ Stopping all project containers..."
            docker ps -a | grep -E 'flask-app|flask-backend|nginx-proxy|ci-cd-demo' | awk '{print $1}' | xargs -r docker stop || true
            docker ps -a | grep -E 'flask-app|flask-backend|nginx-proxy|ci-cd-demo' | awk '{print $1}' | xargs -r docker rm || true

            # æ£€æŸ¥å¹¶é‡Šæ”¾ç«¯å£ 80 å’Œ 443
            echo "ğŸ” Checking port usage..."

            # å°è¯•åœæ­¢å¸¸è§çš„å ç”¨ 80/443 ç«¯å£çš„æœåŠ¡
            echo "Stopping common web servers..."
            sudo systemctl stop nginx || true
            sudo systemctl stop apache2 || true
            sudo systemctl stop httpd || true

            # ä½¿ç”¨ fuser æ€æ­»å ç”¨ç«¯å£çš„è¿›ç¨‹
            echo "Killing processes on port 80..."
            sudo fuser -k 80/tcp || true

            echo "Killing processes on port 443..."
            sudo fuser -k 443/tcp || true

            # ç­‰å¾…ç«¯å£é‡Šæ”¾
            sleep 2

            # éªŒè¯ç«¯å£æ˜¯å¦é‡Šæ”¾
            if sudo ss -tlnp | grep -q ':80 '; then
              echo "âš ï¸  Port 80 still in use after cleanup"
              sudo ss -tlnp | grep ':80 '
            else
              echo "âœ… Port 80 is free"
            fi

            if sudo ss -tlnp | grep -q ':443 '; then
              echo "âš ï¸  Port 443 still in use after cleanup"
              sudo ss -tlnp | grep ':443 '
            else
              echo "âœ… Port 443 is free"
            fi

      # 9ï¸âƒ£ æ„å»ºå¹¶å¯åŠ¨æœåŠ¡ï¼ˆå½“å‰ä»… HTTPï¼‰
      - name: Deploy with Docker Compose
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /opt/ci-cd-flask-demo

            echo "ğŸ” Pre-deployment checks..."
            echo "SSL directory contents:"
            ls -la ssl/ || echo "SSL directory is empty or doesn't exist"
            echo "Nginx config (first 30 lines):"
            head -30 nginx.conf

            # Ensure production secrets stay on the server
            if [ ! -f .env ]; then
              echo "âŒ .env file is missing on the server. Populate it securely via secrets management before deploying."
              exit 1
            fi

            echo "ğŸ” Validating required environment variables..."
            missing_vars=""
            for var in SECRET_KEY DATABASE_URL PASSWORD_PEPPER; do
              if ! grep -E "^${var}=" .env >/dev/null; then
                missing_vars="$missing_vars $var"
              fi
            done
            if [ -n "$missing_vars" ]; then
              echo "âŒ Missing required variables in .env:$missing_vars"
              exit 1
            fi
            echo "âœ… Environment file present (sensitive values remain on the server)"

            echo "ğŸ›  Building Docker images..."
            docker compose build

            echo "ğŸ˜ Starting database for migrations..."
            docker compose up -d postgres
            echo "â³ Waiting for Postgres to become healthy..."
            for i in {1..10}; do
              if docker compose ps | grep postgres | grep -q "(healthy)"; then
                echo "âœ… Postgres is healthy"
                break
              fi
              echo "Waiting for Postgres health... ($i/10)"
              sleep 3
            done

            echo "ğŸ—‚ Running migrations..."
            docker compose run --rm backend alembic upgrade head

            echo "ğŸš€ Starting services..."
            docker compose up -d

            echo "â³ Waiting for backend to become healthy..."
            # Wait for backend health check to pass (max 60 seconds)
            for i in {1..20}; do
              if docker compose ps | grep "backend" | grep -q "(healthy)"; then
                echo "âœ… Backend is healthy!"
                break
              fi
              echo "Waiting for backend health check... ($i/20)"
              sleep 3
            done

            echo "ğŸ“‹ Checking service status..."
            docker compose ps -a

            # æ£€æŸ¥åç«¯æ˜¯å¦å¥åº·
            if ! docker compose ps | grep "backend" | grep -q "(healthy)"; then
              echo "âŒ Backend service is not healthy!"
              echo "ğŸ“‹ Backend logs:"
              docker compose logs backend
              exit 1
            fi

            # ç­‰å¾… nginx å¯åŠ¨å®Œæˆ
            echo "â³ Waiting for nginx to start..."
            sleep 5

            # æ£€æŸ¥ nginx æ˜¯å¦æ­£å¸¸è¿è¡Œï¼ˆä¸æ˜¯ Restarting æˆ– Exitedï¼‰
            if docker compose ps | grep "nginx" | grep -qE "Restarting|Exited"; then
              echo "âŒ Nginx is not running properly!"
              echo "ğŸ“‹ Nginx logs:"
              docker compose logs nginx
              exit 1
            fi

            if ! docker compose ps | grep "nginx" | grep -q "Up"; then
              echo "âŒ Nginx service failed to start!"
              echo "ğŸ“‹ Nginx logs:"
              docker compose logs nginx
              exit 1
            fi

            echo ""
            echo "=========================================="
            echo "âœ… Deployment successful!"
            echo "=========================================="
            echo "âœ… Backend: healthy and running"
            echo "âœ… Nginx: running"
            echo "=========================================="

      # 1ï¸âƒ£0ï¸âƒ£ éªŒè¯éƒ¨ç½²
      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /opt/ci-cd-flask-demo

            echo "ğŸ” Checking container status..."
            docker compose ps

            echo "ğŸ“‹ Checking running containers..."
            docker ps

            # å¥åº·æ£€æŸ¥ - é€šè¿‡ Nginx HTTP (ç«¯å£ 80)
            echo "ğŸ¥ HTTP health check..."
            for i in {1..15}; do
              if curl -f http://localhost/health > /dev/null 2>&1; then
                echo "âœ… HTTP health check passed!"

                # å¦‚æœå­˜åœ¨è‡ªç­¾åè¯ä¹¦ï¼Œæ£€æŸ¥ HTTPS
                if [ -f "ssl/fullchain.pem" ]; then
                  echo "ğŸ” Checking HTTPS (self-signed)..."
                  if curl -f -k https://localhost/health > /dev/null 2>&1; then
                    echo "âœ… HTTPS health check passed!"
                  else
                    echo "âš ï¸  HTTPS not responding"
                  fi
                fi

                echo "âœ… Deployment successful!"
                exit 0
              fi
              echo "â³ Retry $i/15..."
              sleep 3
            done

            echo "âŒ Health check failed!"
            echo "ğŸ“‹ Container logs:"
            docker compose logs --tail=50
            exit 1

      # 1ï¸âƒ£1ï¸âƒ£ æ¸…ç†æ—§é•œåƒ
      - name: Cleanup old images
        if: success()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "ğŸ§¹ Cleaning up old Docker images..."
            docker image prune -f
            echo "âœ… Cleanup complete"

      # 1ï¸âƒ£2ï¸âƒ£ æŠ¥å‘Šéƒ¨ç½²çŠ¶æ€åˆ°ç›‘æ§å¹³å°
      - name: Report deployment to dashboard
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "ğŸ“Š Reporting deployment status to dashboard..."

            # ç¡®å®šéƒ¨ç½²çŠ¶æ€
            if [ "${{ job.status }}" = "success" ]; then
              STATUS="success"
            else
              STATUS="failed"
            fi

            export PIPE_STATUS="$STATUS"
            export PIPE_OWNER="${{ github.actor }}"
            export PIPE_BRANCH="${{ github.ref_name }}"
            export PIPE_SHA="${{ github.sha }}"
            export PIPE_MESSAGE="${{ github.event.head_commit.message }}"
            export PIPE_WORKFLOW="${{ github.workflow }}"
            export PIPE_RUN_ID="${{ github.run_id }}"
            export PIPE_RUN_NUMBER="${{ github.run_number }}"

            PAYLOAD=$(python3 - <<'PY'
            import json
            import os

            payload = {
                "name": "CI-CD-flask-demo",
                "description": "Main deployment pipeline",
                "status": os.environ.get("PIPE_STATUS"),
                "owner": os.environ.get("PIPE_OWNER"),
                "branch": os.environ.get("PIPE_BRANCH"),
                "commitSha": os.environ.get("PIPE_SHA"),
                "commitMessage": os.environ.get("PIPE_MESSAGE"),
                "workflowName": os.environ.get("PIPE_WORKFLOW"),
                "runId": os.environ.get("PIPE_RUN_ID"),
                "runNumber": int(os.environ.get("PIPE_RUN_NUMBER", "0")),
            }
            print(json.dumps(payload))
            PY
            )

            SIGNATURE=$(printf '%s' "$PAYLOAD" | openssl dgst -sha256 -hmac "${{ secrets.PIPELINE_WEBHOOK_SECRET }}" | awk '{print $2}')

            # Add timeout to prevent hanging, retry up to 3 times
            for i in {1..3}; do
              if timeout 10s curl -X POST http://localhost/api/integrations/github \
                -H "Content-Type: application/json" \
                -H "X-Hub-Signature-256: sha256=$SIGNATURE" \
                -d "$PAYLOAD" 2>/dev/null; then
                echo "âœ… Deployment status reported"
                break
              else
                echo "âš ï¸  Failed to report to dashboard (attempt $i/3)"
                [ $i -lt 3 ] && sleep 2
              fi
            done
