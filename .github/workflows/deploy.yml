name: ğŸš€ Deploy to GCP Ubuntu Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ æ£€æŸ¥å½“å‰ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ å°†é¡¹ç›®ä¸Šä¼ åˆ°ä½ çš„äº‘æœåŠ¡å™¨
      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: ".,!.git,!.github,!__pycache__,!*.pyc,!.pytest_cache,!.venv"
          target: "/opt/ci-cd-flask-demo"
          strip_components: 0
          overwrite: true

      # 3ï¸âƒ£ åœæ­¢å½“å‰è¿è¡Œçš„æœåŠ¡
      - name: Stop current services
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /opt/ci-cd-flask-demo
            if [ -f docker-compose.yml ]; then
              echo "ğŸ›‘ Stopping current services..."
              docker compose down || true
            fi

      # 4ï¸âƒ£ æ„å»ºå¹¶å¯åŠ¨æ–°æœåŠ¡
      - name: Deploy with Docker Compose
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /opt/ci-cd-flask-demo

            echo "ğŸ›  Building Docker images..."
            docker compose build

            echo "ğŸš€ Starting services..."
            docker compose up -d

            echo "â³ Waiting for services to be ready..."
            sleep 10

      # 5ï¸âƒ£ éªŒè¯éƒ¨ç½²
      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /opt/ci-cd-flask-demo

            echo "ğŸ” Checking container status..."
            docker compose ps

            # å¥åº·æ£€æŸ¥ - é€šè¿‡ Nginx (ç«¯å£ 80)
            echo "ğŸ¥ Health check through Nginx..."
            for i in {1..15}; do
              if curl -f http://localhost/health > /dev/null 2>&1; then
                echo "âœ… Nginx health check passed!"

                # å¥åº·æ£€æŸ¥ - ç›´æ¥è®¿é—® Flask (ç«¯å£ 8000)
                if curl -f http://localhost:8000/health > /dev/null 2>&1; then
                  echo "âœ… Flask health check passed!"
                  echo "âœ… Deployment successful!"
                  exit 0
                fi
              fi
              echo "â³ Retry $i/15..."
              sleep 3
            done

            echo "âŒ Health check failed!"
            docker compose logs
            exit 1

      # 6ï¸âƒ£ æ¸…ç†æ—§é•œåƒ
      - name: Cleanup old images
        if: success()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "ğŸ§¹ Cleaning up old Docker images..."
            docker image prune -f
            echo "âœ… Cleanup complete"