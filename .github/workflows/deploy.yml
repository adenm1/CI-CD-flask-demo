name: ğŸš€ Deploy to GCP Ubuntu Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ æ£€æŸ¥å½“å‰ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ å°†é¡¹ç›®ä¸Šä¼ åˆ°ä½ çš„äº‘æœåŠ¡å™¨
      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: ".,!.git,!.github,!__pycache__,!*.pyc,!.pytest_cache,!.venv"
          target: "/opt/ci-cd-flask-demo"
          strip_components: 0
          overwrite: true

      # 3ï¸âƒ£ åœæ­¢å½“å‰è¿è¡Œçš„æœåŠ¡
      - name: Stop current services
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /opt/ci-cd-flask-demo
            if [ -f docker-compose.yml ]; then
              echo "ğŸ›‘ Stopping current services..."
              docker compose down || true
            fi

      # 4ï¸âƒ£ ç”Ÿæˆè‡ªç­¾å SSL è¯ä¹¦ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
      - name: Setup self-signed SSL certificate
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /opt/ci-cd-flask-demo

            # åˆ›å»º SSL ç›®å½•
            mkdir -p ssl

            # æ£€æŸ¥è¯ä¹¦æ˜¯å¦å·²å­˜åœ¨
            if [ ! -f ssl/fullchain.pem ]; then
              echo "ğŸ” Generating self-signed SSL certificate..."

              # ç”Ÿæˆè‡ªç­¾åè¯ä¹¦ï¼ˆæœ‰æ•ˆæœŸ1å¹´ï¼‰
              openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
                -keyout ssl/privkey.pem \
                -out ssl/fullchain.pem \
                -subj "/C=US/ST=State/L=City/O=Flask-Demo/CN=${{ secrets.SERVER_IP }}" \
                -addext "subjectAltName=IP:${{ secrets.SERVER_IP }}" 2>/dev/null || \
              openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
                -keyout ssl/privkey.pem \
                -out ssl/fullchain.pem \
                -subj "/C=US/ST=State/L=City/O=Flask-Demo/CN=${{ secrets.SERVER_IP }}"

              if [ $? -eq 0 ]; then
                echo "âœ… Self-signed certificate created for HTTPS"
              else
                echo "âš ï¸  Failed to create certificate, using HTTP only"
              fi
            else
              echo "âœ… SSL certificate already exists"
            fi

      # 5ï¸âƒ£ æ„å»ºå¹¶å¯åŠ¨æœåŠ¡
      - name: Deploy with Docker Compose
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /opt/ci-cd-flask-demo

            echo "ğŸ›  Building Docker images..."
            docker compose build

            echo "ğŸš€ Starting services..."
            docker compose up -d

            echo "â³ Waiting for services to be ready..."
            sleep 10

      # 6ï¸âƒ£ éªŒè¯éƒ¨ç½²
      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /opt/ci-cd-flask-demo

            echo "ğŸ” Checking container status..."
            docker compose ps

            echo "ğŸ“‹ Checking running containers..."
            docker ps

            # å¥åº·æ£€æŸ¥ - é€šè¿‡ Nginx HTTP (ç«¯å£ 80)
            echo "ğŸ¥ HTTP health check..."
            for i in {1..15}; do
              if curl -f http://localhost/health > /dev/null 2>&1; then
                echo "âœ… HTTP health check passed!"

                # å¦‚æœå­˜åœ¨è‡ªç­¾åè¯ä¹¦ï¼Œæ£€æŸ¥ HTTPS
                if [ -f "ssl/fullchain.pem" ]; then
                  echo "ğŸ” Checking HTTPS (self-signed)..."
                  if curl -f -k https://localhost/health > /dev/null 2>&1; then
                    echo "âœ… HTTPS health check passed!"
                  else
                    echo "âš ï¸  HTTPS not responding"
                  fi
                fi

                echo "âœ… Deployment successful!"
                exit 0
              fi
              echo "â³ Retry $i/15..."
              sleep 3
            done

            echo "âŒ Health check failed!"
            echo "ğŸ“‹ Container logs:"
            docker compose logs --tail=50
            exit 1

      # 6ï¸âƒ£ æ¸…ç†æ—§é•œåƒ
      - name: Cleanup old images
        if: success()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "ğŸ§¹ Cleaning up old Docker images..."
            docker image prune -f
            echo "âœ… Cleanup complete"