name: ğŸš€ Deploy to GCP Ubuntu Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ æ£€æŸ¥å½“å‰ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # 3ï¸âƒ£ æ„å»ºå‰ç«¯
      - name: Build frontend
        run: |
          cd frontend
          echo "ğŸ“¦ Installing dependencies..."
          npm ci
          echo "ğŸ—ï¸ Building frontend..."
          npm run build
          echo "âœ… Frontend build complete!"
          ls -la dist/

      # 4ï¸âƒ£ å°†é¡¹ç›®ä¸Šä¼ åˆ°ä½ çš„äº‘æœåŠ¡å™¨
      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: ".,!.git,!.github,!__pycache__,!*.pyc,!.pytest_cache,!.venv,!src,!.trash,!frontend/node_modules"
          target: "/opt/ci-cd-flask-demo"
          strip_components: 0
          overwrite: true

      # 3ï¸âƒ£ åœæ­¢å½“å‰è¿è¡Œçš„æœåŠ¡å¹¶é‡Šæ”¾ç«¯å£
      - name: Stop current services and free ports
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /opt/ci-cd-flask-demo

            # åœæ­¢ docker-compose æœåŠ¡å¹¶æ¸…ç†å­¤ç«‹å®¹å™¨
            if [ -f docker-compose.yml ]; then
              echo "ğŸ›‘ Stopping docker-compose services..."
              docker compose down --remove-orphans || true
            fi

            # åœæ­¢æ‰€æœ‰ç›¸å…³çš„å®¹å™¨
            echo "ğŸ›‘ Stopping all project containers..."
            docker ps -a | grep -E 'flask-app|flask-backend|nginx-proxy|ci-cd-demo' | awk '{print $1}' | xargs -r docker stop || true
            docker ps -a | grep -E 'flask-app|flask-backend|nginx-proxy|ci-cd-demo' | awk '{print $1}' | xargs -r docker rm || true

            # æ£€æŸ¥å¹¶é‡Šæ”¾ç«¯å£ 80 å’Œ 443
            echo "ğŸ” Checking port usage..."

            # å°è¯•åœæ­¢å¸¸è§çš„å ç”¨ 80/443 ç«¯å£çš„æœåŠ¡
            echo "Stopping common web servers..."
            sudo systemctl stop nginx || true
            sudo systemctl stop apache2 || true
            sudo systemctl stop httpd || true

            # ä½¿ç”¨ fuser æ€æ­»å ç”¨ç«¯å£çš„è¿›ç¨‹
            echo "Killing processes on port 80..."
            sudo fuser -k 80/tcp || true

            echo "Killing processes on port 443..."
            sudo fuser -k 443/tcp || true

            # ç­‰å¾…ç«¯å£é‡Šæ”¾
            sleep 2

            # éªŒè¯ç«¯å£æ˜¯å¦é‡Šæ”¾
            if sudo ss -tlnp | grep -q ':80 '; then
              echo "âš ï¸  Port 80 still in use after cleanup"
              sudo ss -tlnp | grep ':80 '
            else
              echo "âœ… Port 80 is free"
            fi

            if sudo ss -tlnp | grep -q ':443 '; then
              echo "âš ï¸  Port 443 still in use after cleanup"
              sudo ss -tlnp | grep ':443 '
            else
              echo "âœ… Port 443 is free"
            fi

      # 4ï¸âƒ£ ç”Ÿæˆè‡ªç­¾å SSL è¯ä¹¦å¹¶å¯ç”¨ HTTPS
      - name: Setup SSL certificate and enable HTTPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /opt/ci-cd-flask-demo

            # åˆ›å»º SSL ç›®å½•
            mkdir -p ssl

            # æ£€æŸ¥è¯ä¹¦æ˜¯å¦å·²å­˜åœ¨
            if [ ! -f ssl/fullchain.pem ]; then
              echo "ğŸ” Generating self-signed SSL certificate..."

              # ç”Ÿæˆè‡ªç­¾åè¯ä¹¦ï¼ˆæœ‰æ•ˆæœŸ1å¹´ï¼‰
              openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
                -keyout ssl/privkey.pem \
                -out ssl/fullchain.pem \
                -subj "/C=US/ST=State/L=City/O=Flask-Demo/CN=${{ secrets.SERVER_IP }}" \
                -addext "subjectAltName=IP:${{ secrets.SERVER_IP }}" 2>/dev/null || \
              openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
                -keyout ssl/privkey.pem \
                -out ssl/fullchain.pem \
                -subj "/C=US/ST=State/L=City/O=Flask-Demo/CN=${{ secrets.SERVER_IP }}"

              if [ $? -eq 0 ]; then
                echo "âœ… Self-signed certificate created"

                # å¯ç”¨ HTTPSï¼šå–æ¶ˆæ³¨é‡Š nginx.conf ä¸­çš„ HTTPS server å—ï¼ˆä»ç¬¬32è¡Œå¼€å§‹ï¼‰
                sed -i '32,$ s/^# //' nginx.conf

                echo "âœ… HTTPS enabled in nginx.conf"
              else
                echo "âš ï¸  Failed to create certificate, using HTTP only"
              fi
            else
              echo "âœ… SSL certificate already exists"

              # ç¡®ä¿ HTTPS å·²å¯ç”¨ï¼ˆæ£€æŸ¥ç¬¬32è¡Œä¹‹åæ˜¯å¦è¿˜æœ‰æ³¨é‡Šï¼‰
              if sed -n '32,$ p' nginx.conf | grep -q '^# '; then
                sed -i '32,$ s/^# //' nginx.conf
                echo "âœ… HTTPS enabled in nginx.conf"
              else
                echo "âœ… HTTPS already enabled"
              fi
            fi

      # 5ï¸âƒ£ æ„å»ºå¹¶å¯åŠ¨æœåŠ¡
      - name: Deploy with Docker Compose
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /opt/ci-cd-flask-demo

            echo "ğŸ” Pre-deployment checks..."
            echo "SSL directory contents:"
            ls -la ssl/ || echo "SSL directory is empty or doesn't exist"
            echo "Nginx config (first 30 lines):"
            head -30 nginx.conf

            # Create .env file if it doesn't exist
            if [ ! -f .env ]; then
              echo "ğŸ“ Creating .env file from .env.example..."
              cp .env.example .env
              echo "âœ… .env file created"
            else
              echo "âœ… .env file already exists"
            fi

            echo "ğŸ›  Building Docker images..."
            docker compose build

            echo "ğŸš€ Starting services..."
            docker compose up -d

            echo "â³ Waiting for backend to become healthy..."
            # Wait for backend health check to pass (max 60 seconds)
            for i in {1..20}; do
              if docker compose ps | grep "backend" | grep -q "Up (healthy)"; then
                echo "âœ… Backend is healthy!"
                break
              fi
              echo "Waiting for backend health check... ($i/20)"
              sleep 3
            done

            echo "ğŸ“‹ Checking service status..."
            docker compose ps -a

            # æ£€æŸ¥åç«¯æ˜¯å¦å¥åº·
            if ! docker compose ps | grep "backend" | grep -q "Up (healthy)"; then
              echo "âŒ Backend service is not healthy!"
              echo "ğŸ“‹ Backend logs:"
              docker compose logs backend
              exit 1
            fi

            # æ£€æŸ¥ nginx æ˜¯å¦å¯åŠ¨
            if ! docker compose ps | grep "nginx" | grep -q "Up"; then
              echo "âŒ Nginx service failed to start!"
              echo "ğŸ“‹ Nginx logs:"
              docker compose logs nginx
              exit 1
            fi

      # 6ï¸âƒ£ éªŒè¯éƒ¨ç½²
      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /opt/ci-cd-flask-demo

            echo "ğŸ” Checking container status..."
            docker compose ps

            echo "ğŸ“‹ Checking running containers..."
            docker ps

            # å¥åº·æ£€æŸ¥ - é€šè¿‡ Nginx HTTP (ç«¯å£ 80)
            echo "ğŸ¥ HTTP health check..."
            for i in {1..15}; do
              if curl -f http://localhost/health > /dev/null 2>&1; then
                echo "âœ… HTTP health check passed!"

                # å¦‚æœå­˜åœ¨è‡ªç­¾åè¯ä¹¦ï¼Œæ£€æŸ¥ HTTPS
                if [ -f "ssl/fullchain.pem" ]; then
                  echo "ğŸ” Checking HTTPS (self-signed)..."
                  if curl -f -k https://localhost/health > /dev/null 2>&1; then
                    echo "âœ… HTTPS health check passed!"
                  else
                    echo "âš ï¸  HTTPS not responding"
                  fi
                fi

                echo "âœ… Deployment successful!"
                exit 0
              fi
              echo "â³ Retry $i/15..."
              sleep 3
            done

            echo "âŒ Health check failed!"
            echo "ğŸ“‹ Container logs:"
            docker compose logs --tail=50
            exit 1

      # 6ï¸âƒ£ æ¸…ç†æ—§é•œåƒ
      - name: Cleanup old images
        if: success()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "ğŸ§¹ Cleaning up old Docker images..."
            docker image prune -f
            echo "âœ… Cleanup complete"