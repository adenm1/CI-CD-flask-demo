name: ğŸš€ Deploy to GCP Ubuntu Server

on:
  push:
    branches: [ main ]

jobs:
  # Job 1: æ„å»ºå’Œæµ‹è¯•
  build:
    name: ğŸ—ï¸ Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.0

      - name: Setup Python
        uses: actions/setup-python@v6.1.0
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install backend dependencies
        run: pip install -r requirements.txt

      - name: Run backend tests (quick)
        run: pytest backend/tests --maxfail=1 --disable-warnings -q -x
        timeout-minutes: 3

      - name: Setup Node.js
        uses: actions/setup-node@v6.0.0
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: cd frontend && npm ci

      - name: Type-check frontend (quick)
        run: cd frontend && npm run check
        timeout-minutes: 2

      - name: Build frontend
        run: cd frontend && npm run build
        timeout-minutes: 3

      - name: Upload build artifacts
        uses: actions/upload-artifact@v5.0.0
        with:
          name: build-artifacts
          path: |
            frontend/dist/
            backend/
            requirements.txt
            docker-compose.yml
            Dockerfile
            nginx.conf
          retention-days: 1

  # Job 2: éƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼ˆä»…åœ¨æ„å»ºæˆåŠŸåæ‰§è¡Œï¼‰
  deploy:
    name: ğŸš€ Deploy to Server
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.0

      - name: Download build artifacts
        uses: actions/download-artifact@v6.0.0
        with:
          name: build-artifacts
          path: .

      - name: Stop services and prepare directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          timeout: 5m
          command_timeout: 5m
          script: |
            set -e

            echo "ğŸ”„ Step 1: Stop old services"
            cd /opt/CI-CD-flask-demo 2>/dev/null || true
            if [ -f docker-compose.yml ]; then
              docker compose down --remove-orphans || true
            fi

            # å¼ºåˆ¶æ¸…ç†ç«¯å£
            sudo fuser -k 80/tcp 2>/dev/null || true
            sudo fuser -k 443/tcp 2>/dev/null || true

            echo "âœ… Services stopped"

            echo "ğŸ—‘ï¸ Step 2: Clean deployment directory"
            # å¤‡ä»½ .env æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if [ -f /opt/CI-CD-flask-demo/.env ]; then
              cp /opt/CI-CD-flask-demo/.env /tmp/.env.backup
              echo "âœ… Backed up .env file"
            fi

            # åˆ é™¤æ‰€æœ‰æ–‡ä»¶å’Œéšè—æ–‡ä»¶ï¼ˆä¿ç•™ç›®å½•æœ¬èº«ï¼‰
            cd /opt/CI-CD-flask-demo
            sudo rm -rf * .[^.]* 2>/dev/null || true

            # ç¡®ä¿ç›®å½•æƒé™æ­£ç¡®
            sudo chown -R ${{ secrets.SERVER_USER }}:${{ secrets.SERVER_USER }} /opt/CI-CD-flask-demo
            sudo chmod 755 /opt/CI-CD-flask-demo

            # æ¢å¤ .env æ–‡ä»¶
            if [ -f /tmp/.env.backup ]; then
              mv /tmp/.env.backup /opt/CI-CD-flask-demo/.env
              echo "âœ… Restored .env file"
            fi

            echo "âœ… Directory prepared (cleaned and owned by ${{ secrets.SERVER_USER }})"

      - name: Copy files to server
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          timeout: 10m
          command_timeout: 10m
          source: ".,!.git,!.github,!__pycache__,!*.pyc,!.pytest_cache,!.venv,!src,!.trash,!frontend/node_modules,!.env,!.env.local,!.env.production,!.env.development,!.env.test,!.env.staging,!.envrc"
          target: "/opt/CI-CD-flask-demo"
          strip_components: 0
          overwrite: true

      - name: Deploy application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          timeout: 15m
          command_timeout: 15m
          script: |
            set -e

            cd /opt/CI-CD-flask-demo

            echo "ğŸ” Step 2: Validate environment"
            if [ ! -f .env ]; then
              echo "âŒ .env file missing on server!"
              exit 1
            fi

            # éªŒè¯å¿…éœ€çš„ç¯å¢ƒå˜é‡
            for var in SECRET_KEY DATABASE_URL PASSWORD_PEPPER; do
              if ! grep -E "^${var}=" .env >/dev/null 2>&1; then
                echo "âŒ Missing required variable: $var"
                exit 1
              fi
            done
            echo "âœ… Environment validated"

            echo "ğŸ³ Step 3: Build Docker images"
            docker compose build --no-cache

            echo "ğŸ—ƒï¸ Step 4: Start database"
            docker compose up -d postgres

            # ç­‰å¾…æ•°æ®åº“å¥åº·
            echo "â³ Waiting for database to be healthy..."
            for i in {1..30}; do
              if docker compose ps postgres | grep -q "healthy"; then
                echo "âœ… Database ready"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "âŒ Database failed to become healthy after 60s"
                docker compose logs postgres --tail=30
                exit 1
              fi
              echo "â³ Attempt $i/30..."
              sleep 2
            done

            echo "ğŸ“Š Step 5: Run database migrations"
            # è¿è¡Œè¿ç§» - è¿ç§»è„šæœ¬ç°åœ¨å…·æœ‰å¹‚ç­‰æ€§,å¯å®‰å…¨é‡å¤è¿è¡Œ
            if docker compose run --rm backend alembic upgrade head; then
              echo "âœ… Migrations completed successfully"
            else
              echo "âŒ Migration failed"
              echo "ğŸ“‹ Migration logs:"
              docker compose logs backend --tail=50
              exit 1
            fi

            echo "ğŸš€ Step 6: Start all services"
            docker compose up -d

            # ç­‰å¾…åç«¯å¥åº·ï¼ˆ2åˆ†é’Ÿè¶…æ—¶ï¼‰
            echo "â³ Waiting for backend to be healthy..."
            BACKEND_HEALTHY=false
            for i in {1..40}; do
              if docker compose ps backend | grep -q "healthy"; then
                echo "âœ… Backend healthy after ${i}0 seconds"
                BACKEND_HEALTHY=true
                break
              fi

              # æ¯10æ¬¡æ£€æŸ¥ï¼ˆ30ç§’ï¼‰è¾“å‡ºä¸€æ¬¡æ—¥å¿—
              if [ $((i % 10)) -eq 0 ]; then
                echo "â³ Still waiting... ($i/40, ${i}0s elapsed)"
                echo "ğŸ“‹ Recent backend logs:"
                docker compose logs backend --tail=10
              fi

              sleep 3
            done

            # éªŒè¯åç«¯æœåŠ¡çŠ¶æ€
            if [ "$BACKEND_HEALTHY" = false ]; then
              echo "âŒ Backend failed to become healthy after 120s"
              echo "ğŸ“‹ Full backend logs:"
              docker compose logs backend --tail=100
              echo ""
              echo "ğŸ³ Container status:"
              docker compose ps backend
              echo ""
              echo "âš ï¸ Deployment failed - backend not healthy"
              exit 1
            fi

            # éªŒè¯ Nginx çŠ¶æ€
            echo "ğŸ” Checking Nginx status..."
            if ! docker compose ps nginx | grep -q "Up"; then
              echo "âŒ Nginx failed to start"
              echo "ğŸ“‹ Nginx logs:"
              docker compose logs nginx --tail=50
              echo ""
              echo "ğŸ³ Container status:"
              docker compose ps nginx
              exit 1
            fi
            echo "âœ… Nginx is running"

            echo ""
            echo "âœ… All services started successfully"
            echo "ğŸ³ Final container status:"
            docker compose ps

      - name: Health check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          timeout: 3m
          command_timeout: 3m
          script: |
            cd /opt/CI-CD-flask-demo

            echo "ğŸ¥ Running application health checks..."
            echo ""

            HEALTH_PASSED=false
            for i in {1..20}; do
              HTTP_CODE=$(curl -s -o /tmp/health.json -w "%{http_code}" http://localhost/health 2>/dev/null || echo "000")

              if [ "$HTTP_CODE" = "200" ]; then
                echo "âœ… Health check passed! (attempt $i)"
                echo "ğŸ“‹ Health response:"
                cat /tmp/health.json | jq '.' 2>/dev/null || cat /tmp/health.json
                HEALTH_PASSED=true
                break
              else
                if [ $((i % 5)) -eq 0 ]; then
                  echo "â³ Attempt $i/20 - HTTP $HTTP_CODE (waiting ${i}s so far)"
                fi
                sleep 2
              fi
            done

            if [ "$HEALTH_PASSED" = false ]; then
              echo ""
              echo "âŒ Health check failed after 40 seconds"
              echo ""
              echo "ğŸ” Diagnostic information:"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

              echo ""
              echo "ğŸ³ Container status:"
              docker compose ps

              echo ""
              echo "ğŸŒ Port bindings:"
              docker compose ps --format json | jq -r '.[].Publishers[] | select(.TargetPort == 80 or .TargetPort == 8000)' 2>/dev/null || netstat -tlnp | grep -E ':(80|8000) '

              echo ""
              echo "ğŸ“‹ Recent logs from all services:"
              docker compose logs --tail=20

              echo ""
              echo "âš ï¸ Deployment marked as FAILED - health endpoint not responding"
              exit 1
            fi

            echo ""
            echo "âœ… All health checks passed successfully"

  # Job 3: æ¸…ç†ï¼ˆä»…åœ¨éƒ¨ç½²æˆåŠŸåæ‰§è¡Œï¼‰
  cleanup:
    name: ğŸ§¹ Cleanup
    needs: deploy
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Cleanup old resources
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          timeout: 2m
          command_timeout: 2m
          script: |
            echo "ğŸ§¹ Cleaning up..."

            # æ¸…ç†Dockerèµ„æº
            docker image prune -f
            docker volume prune -f || true

            echo "âœ… Cleanup complete"

  # Job 4: æŠ¥å‘Šéƒ¨ç½²çŠ¶æ€
  report:
    name: ğŸ“Š Report Status
    needs: [ build, deploy ]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Report deployment status
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          timeout: 30s
          command_timeout: 30s
          script: |
            STATUS="${{ needs.deploy.result }}"

            cd /opt/CI-CD-flask-demo || exit 0

            export PIPE_STATUS="$STATUS"
            export PIPE_OWNER="${{ github.actor }}"
            export PIPE_BRANCH="${{ github.ref_name }}"
            export PIPE_SHA="${{ github.sha }}"
            export PIPE_MESSAGE="${{ github.event.head_commit.message }}"

            PAYLOAD=$(python3 - <<'PY'
            import json, os
            print(json.dumps({
                "name": "CI-CD-flask-demo",
                "status": os.environ.get("PIPE_STATUS"),
                "owner": os.environ.get("PIPE_OWNER"),
                "branch": os.environ.get("PIPE_BRANCH"),
                "commitSha": os.environ.get("PIPE_SHA"),
                "commitMessage": os.environ.get("PIPE_MESSAGE")
            }))
            PY
            )

            SIGNATURE=$(printf '%s' "$PAYLOAD" | openssl dgst -sha256 -hmac "${{ secrets.PIPELINE_WEBHOOK_SECRET }}" | awk '{print $2}')

            timeout 5s curl -X POST http://localhost/api/integrations/github \
              -H "Content-Type: application/json" \
              -H "X-Hub-Signature-256: sha256=$SIGNATURE" \
              -d "$PAYLOAD" 2>/dev/null || echo "âš ï¸ Failed to report status"
